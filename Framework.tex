\section{A Framework built on pandas}
\label{sec:framework}

There are several motivations for building an analysis framework around the \code{pandas DataFrame}. 
The guiding principle underlying the design of this framework is to enable exploratory investigation.
This requires both intelligent memory management for handling out-of-core datasets, and a robust indexing system to ensure that particle properties do not become misaligned in memory.
Using  the \code{pandas DataFrame} as the primary data container rather than separate \code{numpy} arrays makes it much easier to keep different particle properties indexed correctly while still affording the flexibility to load and remove data from memory at will.
In addition, \code{pandas} itself is a thoroughly documented, open-source, BSD-licensed library providing high-performance, easy-to-use data structures and analysis tools, and has a strong community of developers working to improve it.  
More broadly, as \code{pandas} is becoming the de-facto standard for data analysis in python, doing so simplifies interoperability with the rest of the tools in the ecosystem.

\code{gadfly} is designed for use with simulation data stored in the HDF5 format.  
While we otherwise aim to keep \code{gadfly} as general as possible, some assumptions about the storage format are necessary.
Each particle type is expected to be contained in a different HDF5 group, labeled \code{PartType0, PartType1}, etc; a \code{Header} group is also expected, containing metadata for the simulation snapshot as HDF5 attributes. 
All particles are expected to have the following fields defined: particle IDs, masses, coordinates, and velocities.  
SPH particles are additionally expected to have a smoothing length, density, and internal energy.  

This section provides an overview of the design and capabilities of the \code{gadfly} framework.  
Section \ref{sec:hierarchy} describes the \code{Simulation}, \code{Snapshot}, and \code{PartType DataFrame} objects at the core of \code{gadfly}.  
Our memory-efficient approach to data access is outlined in Section \ref{sec:fileIO}, and our handling of unit conversions and coordinate transformations is discussed in Sections \ref{sec:units} and \ref{sec:coords}, respectively.

\subsection{Organizational Structure}
\label{sec:hierarchy}

\subsubsection{\code{PartType} Dataframes}
\label{sec:df}
Data for each particle type (e.g., dark matter, gas, etc.) is stored in a separate \code{PartType} dataframe and indexed by particle ID number. 
Individual fields can be loaded into the dataframes and deleted at will, with coherent slicing across multiple data fields, courtesy of \code{pandas}.  
The base \code{PartType} objects, \code{PartTypeNbody} and \code{PartTypeSPH}, are standard \code{pandas} dataframes, with additional functionality for loading standard \textsc{gadget} particle fields from HDF5, converting units, and performing coordinate transformations.  
As such, \code{gadfly} dataframes retain all the capabilities of the \code{pandas.DataFrame} from which they inherit, and any operation that creates a new dataframe instance returns a standard \code{pandas} dataframe.

Nonstandard particle fields can be easily loaded into \code{gadfly} as well; fields loaded in this manner simply lack automated unit conversion.
Alternatively, a custom dataframe class inheriting from \code{PartTypeNbody} or \code{PartTypeSPH} as appropriate can be defined to provide loading functions for both nonstandard particle fields and additional derived properties (i.e., temperature). And example of such a custom class---\code{PartTypeCustom.py}---is provided in the examples distributed with \code{gadfly}, and the usage of such a custom class is demonstrated in Figure \ref{fig:PartTypeCustom}.

\subsubsection{\code{Snapshot}}
\label{sec:snap}
Each \code{Snapshot} object represents a single HDF5 snapshot file on disk.  File access---provided by \code{h5py}---is handled via the \code{Snapshot} object, and the actual particle data, loaded as needed into the \code{PartType} dataframes described in Section \ref{sec:df}, is gathered here with each particle type contained in a separate \code{PartType} dataframe.  
The information contained in the \textsc{gadget} header is also kept here in a \code{Header} object, along with access to the additional metadata and unit information stored in the relevant \code{Simulation} object.

\subsubsection{\code{Simulation}}
\label{sec:sim}
Metadata relevant to the simulation as a whole is then gathered in a simulation class, which also implements batch processing methods.

\subsection{Data Access}
\label{sec:fileIO}

\subsection{Units and physical constants}
\label{sec:units}
Physical constants are imported from astropy, where necessary.  Unit conversions are dealt with in a similar manner; unfortunately pandas DataFrames do not play nice with astropy quantities, and so the unit system included here is rudimentary at best.

\subsection{Coordinate Transformations}
\label{sec:coords}
pyGadget includes a coordinate module for converting between cartesian, spherical, and cylindrical coordinates, linear coordinate translation, and arbitrary axis rotation.